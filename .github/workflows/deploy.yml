name: Deploy to Namecheap

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      server:
        description: 'FTP server address (e.g. ftp.beelsimon.com)'
        required: false
        default: 'ftp.beelsimon.com'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: 🚚 Get latest code
      uses: actions/checkout@v4
      
    - name: 🔧 Prepare hosting-specific files
      run: |
        # Copy hosting-specific index.php
        cp public/index-hosting.php public/index.php
        # Create production environment file
        cat > .env << 'EOF'
        APP_NAME="Thila Coloma"
        APP_ENV=production
        APP_KEY=
        APP_DEBUG=false
        APP_URL=https://beelsimon.com/tc
        
        LOG_CHANNEL=stack
        LOG_DEPRECATIONS_CHANNEL=null
        LOG_LEVEL=error
        
        DB_CONNECTION=sqlite
        DB_DATABASE=/home/beelkstc/tc_app/database/database.sqlite
        
        BROADCAST_DRIVER=log
        CACHE_DRIVER=file
        FILESYSTEM_DISK=local
        QUEUE_CONNECTION=sync
        SESSION_DRIVER=file
        SESSION_LIFETIME=120
        
        STATAMIC_LICENSE_KEY=
        STATAMIC_STACHE_WATCHER=false
        STATAMIC_STATIC_CACHING_STRATEGY=null
        EOF
        # Clear composer cache and install dependencies
        composer clear-cache
        composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
      
    - name: 🔍 Debug server configuration
      run: |
        echo "Server from input: '${{ github.event.inputs.server }}'"
        echo "Fallback server: 'ftp.beelsimon.com'"
        echo "Final server: '${{ github.event.inputs.server || 'ftp.beelsimon.com' }}'"
      
    - name: 📂 Sync application files to hosting
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      env:
        INPUT_SERVER: ${{ github.event.inputs.server || 'ftp.beelsimon.com' }}
      with:
        server: ${{ github.event.inputs.server || 'ftp.beelsimon.com' }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        passive: true
        timeout: 300000
        dangerous-clean-slate: false
        local-dir: ./
        server-dir: tc_app/
        exclude-glob-base-dir: ./
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/tests/**
          **/storage/logs/**
          **/storage/framework/cache/**
          **/storage/framework/sessions/**
          **/storage/framework/views/**
          **/public/**
          
    - name: 🌐 Sync public files to web directory
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      env:
        INPUT_SERVER: ${{ github.event.inputs.server || 'ftp.beelsimon.com' }}
      with:
        server: ${{ github.event.inputs.server || 'ftp.beelsimon.com' }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        passive: true
        timeout: 300000
        dangerous-clean-slate: false
        local-dir: ./public/
        server-dir: public_html/tc/
        
    - name: 📝 Deploy environment file to app directory
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      env:
        INPUT_SERVER: ${{ github.event.inputs.server || 'ftp.beelsimon.com' }}
      with:
        server: ${{ github.event.inputs.server || 'ftp.beelsimon.com' }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        protocol: ftp
        port: 21
        passive: true
        timeout: 300000
        dangerous-clean-slate: false
        local-dir: ./
        server-dir: tc_app/
        exclude: |
          **/*
          !.env
